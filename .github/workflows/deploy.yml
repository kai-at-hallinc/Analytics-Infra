name: deploy

on:
    workflow_call:
        inputs:
            environmentType:
                required: true
                type: string
                description: 'The environment to deploy to'
            resourceGroupName:
                required: true
                type: string
                description: 'The resource group to deploy to'
        secrets:
            AZURE_CLIENT_ID:
                required: true
            AZURE_TENANT_ID:
                required: true
            AZURE_SUBSCRIPTION_ID:
                required: true
jobs:
    validate:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v3
        - uses: azure/login@v1
          name: Sign in to Azure
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        - if: inputs.environmentType != 'Production'
          uses: azure/arm-deploy@v1
          name: run pre-flight validation
          with:
            deploymentName: ${{ github.run_number }}
            resourceGroupName: ${{ inputs.resourceGroupName }}
            template: ./deploy/main.bicep
            parameters: > 
              environmentType=${{ inputs.environmentType }}
            deploymentMode: Validate
            scope: 'resourcegroup'

        - if: inputs.environmentType == 'Production'
          uses: azure/arm-deploy@v1
          name: Run what-if
          with:
            failOnStdErr: false
            resourceGroupName: ${{ inputs.resourceGroupName }}
            template: ./deploy/main.bicep
            parameters: >
              environmentType=${{ inputs.environmentType }}
            additionalArguments: --what-if
            scope: 'resourcegroup'
    
    deploy:
        needs: validate
        environment: ${{ inputs.environmentType }}
        runs-on: ubuntu-latest
        outputs:
            storageAccountName: ${{ steps.deploy.outputs.storageAccountName }}
        steps:
        - uses: actions/checkout@v3
        - uses: azure/login@v1
          name: sign in to Azure
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        - uses: azure/arm-deploy@v1
          id: deploy
          name: deploy bicep file
          with:
            failOnStdErr: false
            deploymentName: ${{ github.run_number }}
            resourceGroupName: ${{ inputs.resourceGroupName }}
            template: ./deploy/main.bicep
            parameters: >
                environmentType=${{ inputs.environmentType }}
            scope: 'resourcegroup'
    
    smoke-test:
        runs-on: ubuntu-latest
        needs: deploy
        steps:
        - uses: actions/checkout@v3
        - uses: azure/login@v1
          name: sign in to Azure
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        - name: Install Azure PowerShell Module
          run: |
            pwsh -Command "Install-Module -Name Az -AllowClobber -Force -Scope CurrentUser"
            pwsh -Command "Import-Module Az"

        - name: Run smoke tests
          run: |
            $container = New-PesterContainer -Path 'deploy/Storage.Tests.ps1' -Data @{ storageAccountName = '${{needs.deploy.outputs.storageAccountName}}'; resourceGroupName = '${{inputs.resourceGroupName}}'}
            Invoke-Pester -Container $container -CI
          shell: pwsh
          continue-on-error: true
    
    print-output:
      runs-on: ubuntu-latest
      needs: deploy
      steps:
        - run: |
            echo "Storage Account Name: ${{ needs.deploy.outputs.storageAccountName }}"
            echo "Storage Account Name: ${{ inputs.resourceGroupName }}"


